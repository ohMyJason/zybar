<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>风口交易吧后台</title>
    <script src="../../user/js/jquery-3.1.1.min.js"></script>
    <script src="../../user/js/jquery.cookie.js"></script>

    <link rel="stylesheet" href="../layui/css/layui.css">
    <script src="../layui/layui.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/nav.js"></script>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
    <div class="layui-header" id="window-header">
    </div>

    <div class="layui-side layui-bg-black" id="window-left">
    </div>

    <div class="layui-body">
        <!-- 内容主体区域 -->


        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
            <legend>直播间</legend>

            <hr class="layui-bg-red">
            <div class="layui-col-md6">
                <legend>老师消息</legend>

            </div>
            <div class="layui-col-md6">
                <legend>网友消息</legend>

            </div>

        </fieldset>


        <div style="padding: 20px; background-color: #F2F2F2;">
            <div class="layui-row layui-col-space15">
                <div class="layui-col-md6" style="height: 400px;overflow: auto" id="teacherChat">
                    <!--<div class="layui-card" id="chatModel">-->
                    <!--<div class="layui-card-header">用户名</div>-->
                    <!--<div class="layui-card-body">-->
                    <!--卡片式面板面板通常用于非白色背景色的主体内<br>-->
                    <!--从而映衬出边框投影-->
                    <!--</div>-->
                    <!--</div>-->
                </div>
                <div class="layui-col-md6" style="height: 400px;overflow: auto" id="userChat">
                    <!--<div class="layui-card">-->
                        <!--<div class="layui-card-header">用户名</div>-->
                        <!--<div class="layui-card-body">-->
                            <!--结合 layui 的栅格系统<br>-->
                            <!--轻松实现响应式布局-->
                        <!--</div>-->
                    <!--</div>-->
                </div>

            </div>
        </div>

        <div style="position:absolute;bottom:0;width:100%;">
            <textarea id="edit" style="display: none;"></textarea>
            <button style="margin-top: 5px" type="button" class="layui-btn layui-btn-normal" id="send">发送</button>
        </div>
        <script>
            var websocket = null;
            //判断当前浏览器是否支持WebSocket
            if ('WebSocket' in window) {
                websocket = new WebSocket("ws://192.168.1.124:8080/websocket");
            } else {
                alert('Not support websocket');
            }


            //将接收到的html代码（消息）贴到版面上
            function setMessage(event) {
                var role = event.data.split("&*&")[0];
                var message = event.data.split("&*&")[1];
                var username = event.data.split("&*&")[2];
                if (role == 2) {
                    $("#teacherChat").append("<div class=\"layui-card\">\n" +
                        "                        <div class=\"layui-card-header\">"+username+"</div>\n" +
                        "                        <div class=\"layui-card-body\">\n" +
                        message +
                        "                        </div>\n" +
                        "                    </div>");
                    scrollDown("teacherChat");
                }else if (role==1){
                    $("#userChat").append("<div class=\"layui-card\">\n" +
                        "                        <div class=\"layui-card-header\">"+username+"</div>\n" +
                        "                        <div class=\"layui-card-body\">\n" +
                          message +
                        "                        </div>\n" +
                        "                    </div>");
                    scrollDown("userChat");
                }
                ResizeImages();
            }


            //连接发生错误的回调方法
            websocket.onerror = function () {
                // setMessageInnerHTML("error");
                layui.use('layer', function () {
                    var layer = layui.layer;
                    layer.alert("连接出现错误，请重新连接");
                })
            };

            //连接成功建立的回调方法
            websocket.onopen = function (event) {
                // setMessageInnerHTML("open");

                layui.use('layer', function () {
                    var layer = layui.layer;
                    layer.alert("连接成功");
                })
            }

            //接收到消息的回调方法
            websocket.onmessage = function (event) {
                setMessage(event);
            }

            //连接关闭的回调方法
            websocket.onclose = function () {
                // setMessageInnerHTML("close");
            }

            //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
            window.onbeforeunload = function () {
                websocket.close();
            }


            //缩放图片到合适大小
            function ResizeImages() {
                var myimg, oldwidth;
                var maxwidth = $("#teacherChat").width() - 60;
                // oldwidth=$("#teacherChat").find("img").width();
                var imgs = document.getElementById('teacherChat').getElementsByTagName('img');   //如果你定义的id不是article，请修改此处

                console.log($("#teacherChat").width());


                for (i = 0; i < imgs.length; i++) {
                    myimg = imgs[i];
                    // 过滤掉表情
                    if (myimg.src.charAt(myimg.src.length - 3) != "g") {
                        // oldwidth = myimg.width;
                        myimg.width = maxwidth;
                        // 注释掉的代码本来想等比例放大的，没办法，获取不到原图片的高
                        // myimg.height=myimg.height*(myimg.width/oldwidth);
                    }
                }
            }

            // 保持滚动条在最下面
            function scrollDown(divId) {
                var content = document.getElementById(divId);
                content.scrollTop = content.scrollHeight;
            }

            layui.use('layedit', function () {
                var layedit = layui.layedit;
                layedit.set({
                    uploadImage: {
                        url: '/uploadChatImg' //接口url
                        , type: 'post' //默认post
                    }
                });

                var index = layedit.build('edit'); //建立编辑器


                //发送消息
                $("#send").click(function () {
                    var content = layedit.getContent(index);

                    console.log(content);
                    if (websocket.readyState!=1){
                        layui.use('layer', function () {
                            var layer = layui.layer;
                            layer.alert("直播间连接出现错误,请刷新页面重新连接");
                        })
                    }
                    var message = "2&*&"+content+"&*&"+$.cookie("username")
                    websocket.send(message);


                })

            });
        </script>

    </div>

    <div class="layui-footer">
        <!-- 底部固定区域 -->
        © layui.com - 风口交易吧
    </div>
</div>
<script>
    //JavaScript代码区域
    layui.use('element', function () {
        var element = layui.element;

        //虚假的局部刷新，通过改变css让左边导航显示对应块
        $("#viewOnline").attr("class", "layui-nav-item layui-nav-itemed")

    });
</script>
</body>
</html>
