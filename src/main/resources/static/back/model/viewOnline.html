<!DOCTYPE html>
<html lang="">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>风口交易吧后台</title>
    <script src="../../user/js/jquery-3.1.1.min.js"></script>
    <script src="../../user/js/jquery.cookie.js"></script>

    <link rel="stylesheet" href="../layui/css/layui.css">
    <script src="../layui/layui.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/backWebSocket.js"></script>
    <style>
        #teacherChat img {
            max-width: 100%;
        }
        html,body{
            height: 100%;
        }
    </style>
    <link rel="stylesheet" href="../css/alert.css">
</head>
<body class="layui-layout-body">
 <!--内容主体区域 -->
<fieldset class="layui-elem-field layui-field-title" style="height: 20%">
    <legend>直播间</legend>
    <div style="margin-top: 20px">
        <div style="width: 100%; margin: 0;">
            <button style="float: left" type="button" id="editMessage" class="layui-btn">发送消息</button>
            <input type="hidden" id="selectOnline" value="0">
            <button style="float: left;margin-left: 10%" type="button" id="restReply" class="layui-btn">取消回复</button>
            <blockquote style="float: left;margin-left: 10%" class="layui-elem-quote" id="replayName">无选择回复</blockquote>

        </div>
    </div>
    <script type="text/javascript" src="../wangEditor-3.1.1/release/wangEditor.min.js"></script>
    <script>
        $(function () {

            $("#userChat").on('click', '.layui-card', function () {
                var replay = $(this).children().eq(0).text() + ":" + $(this).children().eq(1).text().trim();
                $("#replayName").text(replay);

            });

            $("#restReply").click(function () {
                $("#replayName").text("无选择回复");
            });

            $("body").keydown(function () {
                if (event.keyCode == "13") {//keyCode=13是回车键
                    $('#send').click();
                }
            });



            $("#editMessage").click(function () {
                layui.use('layer',function () {
                    var layer = layui.layer;
                    layer.open({
                        type: 1,
                        title: "发送消息",
                        area: ['60%', '50%'],
                        shadeClose: true,
                        content:
                            "<div>\n" +
                            "    <button style=\"margin-right: 20px\" type=\"button\" class=\"layui-btn layui-btn-normal\" id=\"send\">发送</button>\n" +
                            "</div>\n" +
                            "<div id=\"editor\" style='max-height: 40%'></div>"

                    });
                })

                var E = window.wangEditor
                var editor = new E('#editor')
                editor.customConfig.uploadImgServer = '/uploadChatImg'

                editor.customConfig.uploadFileName = 'file'                        // 或者 var editor = new E( document.getElementById('editor') )
                editor.create()


                $("#send").click(function () {
                    var content = editor.txt.html();
                    if (content=='<p><br></p>') {
                        layui.use('layer', function () {
                            var layer = layui.layer;
                            layer.msg("请输入内容");
                        })
                    } else {
                        console.log(content)
                        if (websocket.readyState !== 1) {
                            layui.use('layer', function () {
                                var layer = layui.layer;
                                layer.alert("直播间连接出现错误,请刷新页面重新连接");
                            })
                        } else {
                            var message = {
                                role: 2,
                                content: content,
                                username: $.cookie("username"),
                                photoUrl: $.cookie("photoUrl"),
                                selectOnline: $("#selectOnline").val(),
                                replay: $("#replayName").text(),
                                sentTime: new Date().toLocaleString()
                            }
                            websocket.send(JSON.stringify(message));
                            ajaxPOST("/insertMessage", {
                                message: JSON.stringify(message),
                                selectOnline: 0
                            }, function f(res) {
                                if (res.code == 0) {
                                    layer.msg('发送成功');
                                } else {
                                    layer.msg('操作失败');
                                }

                            })
                        }
                        $("#replayName").text("无选择回复");
                        layer.closeAll()
                    }
                });


            })
        })
    </script>
    <hr class="layui-bg-red">
    <div style="width: 50%;float: left">
        <legend>老师消息</legend>

    </div>
    <div style="width: 50%;float: left">
        <legend>网友消息</legend>
    </div>
</fieldset>


<div style="padding: 20px; background-color: #F2F2F2;height: 80%">
    <!--<div style="width: 100%;height: 100%">-->
        <div style="width:50%;overflow: auto;float: left;overflow-x: hidden" id="teacherChat">
        </div>
        <div  style="width:50%;overflow: auto;float: left" id="userChat">
        </div>

    <!--</div>-->
</div>


<script>
    //JavaScript代码区域
    layui.use('element', function () {
        var element = layui.element;

        //虚假的局部刷新，通过改变css让左边导航显示对应块
        $("#viewOnline").attr("class", "layui-nav-item layui-nav-itemed")

        getHistoryMsg(0);  //获取历史消息
        var screenHeight = window.innerHeight;
        $("#teacherChat").height(screenHeight*0.8-20*2)
        $("#userChat").height(screenHeight*0.8-20*2)

    });
</script>
</body>
</html>
